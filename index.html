<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Science Exhibition - Project Evaluation</title>
  <style>
    :root{
      --bg:#0b1020;--card:#121936;
      --muted:#6b7280;
      --text:#e5e7eb;
      --acc:#7c9cff;
      --good:#22c55e;
      --bad:#ef4444;
      --chip:#1f2a52;
      --chip-border:#2c3a72;
      --border:#232a47;
      --radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(180deg,#0b1020,#0a0f1e 40%);color:var(--text);min-height:100vh}
    
    /* Header - Responsive */
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;position:sticky;top:0;background:#0b1020cc;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);z-index:60;flex-wrap:wrap;gap:8px}
    .brand{display:flex;align-items:center;gap:12px;flex:1;min-width:200px}
    header img{height:40px;width:40px;border-radius:10px;border:1px solid var(--chip-border);object-fit:cover}
    header h1{font-size:16px;font-weight:700;line-height:1.2}
    header small{display:block;color:var(--muted);font-size:12px}
    #userControls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .userBadge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-border);font-size:13px;color:#c7d2fe;white-space:nowrap}
    .headerLogout{appearance:none;border:1px solid var(--chip-border);background:transparent;color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600;font-size:13px}

    /* Responsive header for mobile */
    @media (max-width:640px){
      header{padding:10px 12px}
      header h1{font-size:14px}
      header small{font-size:11px}
      header img{height:32px;width:32px}
      .userBadge{font-size:12px;padding:4px 8px}
      .headerLogout{padding:6px 8px;font-size:12px}
    }

    /* Container - Responsive */
    .container{max-width:1100px;margin:14px auto;padding:0 16px}
    @media (max-width:640px){
      .container{padding:0 12px;margin:10px auto}
    }

    /* Cards */
    .card{background:linear-gradient(180deg,#101636,#0d1430);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.25);margin-bottom:12px}
    @media (max-width:640px){
      .card{padding:12px;border-radius:10px}
    }

    /* Grid System - Fully Responsive */
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    
    @media (max-width:900px){
      .col-8{grid-column:span 12}
    }
    @media (max-width:768px){
      .col-6,.col-4,.col-3{grid-column:span 12}
    }

    /* Typography - Responsive */
    h2{margin:0 0 10px 0;font-size:20px;line-height:1.3}
    h3{margin:6px 0 10px 0;font-size:16px;color:#cbd5e1;line-height:1.3}
    @media (max-width:640px){
      h2{font-size:18px}
      h3{font-size:15px}
    }

    /* Form Elements - Responsive */
    label{display:block;margin:8px 0 4px;color:#c7d2fe;font-size:13px;font-weight:500}
    input,select,textarea{width:100%;background:#0e1430;border:1px solid var(--chip-border);border-radius:10px;padding:10px 12px;color:var(--text);outline:none;font-size:14px;font-family:inherit}
    input:focus,select:focus,textarea:focus{border-color:var(--acc)}
    textarea{min-height:90px;resize:vertical}
    @media (max-width:640px){
      input,select,textarea{padding:9px 10px;font-size:14px}
      label{font-size:12px}
    }

    .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4}
    .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-border);gap:8px;color:#c7d2fe;font-size:12px;white-space:nowrap}
    
    /* Buttons - Touch Friendly */
    .btn{appearance:none;border:1px solid var(--chip-border);background:linear-gradient(180deg,#1c2658,#1a2454);color:white;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .06s ease,opacity .15s;font-size:14px;white-space:nowrap;min-height:44px;display:inline-flex;align-items:center;justify-content:center}
    .btn:hover:not(:disabled){transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#111834}
    .btn.danger{background:linear-gradient(180deg,#3a0b14,#2a0a10);border-color:#5b111f}
    
    @media (max-width:640px){
      .btn{padding:10px 12px;font-size:13px;min-height:42px}
    }

    /* Toolbar - Responsive */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    @media (max-width:560px){ 
      .toolbar{gap:8px}
      .toolbar .btn{flex:1;min-width:120px}
    }
    @media (max-width:400px){
      .toolbar{flex-direction:column;align-items:stretch}
      .toolbar .btn{width:100%;min-width:auto}
    }

    /* Tables - Responsive */
    .table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -16px;padding:0 16px}
    @media (max-width:640px){
      .table-wrapper{margin:0 -12px;padding:0 12px}
    }
    table{width:100%;border-collapse:separate;border-spacing:0 8px;min-width:600px}
    th,td{text-align:left;padding:10px 12px}
    @media (max-width:640px){
      th,td{padding:8px 10px;font-size:13px}
    }
    thead th{font-size:12px;color:#cbd5e1;text-transform:uppercase;letter-spacing:.04em}
    tbody tr{background:#0f1534;border:1px solid var(--border)}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}
    
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--chip-border);background:#112055;display:inline-block;white-space:nowrap}
    .error{color:var(--bad);font-size:12px;margin-top:4px}
    .success{color:var(--good)}
    .hidden{display:none !important}

    /* Tabs - Responsive */
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border);margin-bottom:12px;padding-bottom:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin}
    .tabs::-webkit-scrollbar{height:4px}
    .tabs::-webkit-scrollbar-thumb{background:var(--chip-border);border-radius:2px}
    .tab{color:#cbd5e1;padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#0e1430;cursor:pointer;font-weight:600;white-space:nowrap;font-size:13px;min-height:40px;display:inline-flex;align-items:center}
    .tab.active{background:#17204a}
    @media (max-width:640px){
      .tab{padding:8px 10px;font-size:12px}
    }

    /* Modal - Responsive */
    .modal-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background:linear-gradient(180deg, rgba(2,6,23,0.85), rgba(2,6,23,0.75));z-index:120;overflow-y:auto}
    .modal{max-width:920px;width:100%;background:#0c122d;border:1px solid var(--border);border-radius:12px;padding:16px;max-height:90vh;overflow-y:auto}
    @media (max-width:768px){
      .modal-wrap{padding:12px;align-items:flex-start}
      .modal{padding:14px;border-radius:10px;max-height:none;margin:20px 0}
    }
    @media (max-width:480px){ 
      .modal-wrap{padding:8px}
      .modal{padding:12px;border-radius:8px}
    }

    /* Progress bar */
    .progressWrap{margin-top:10px}
    .progressBar{height:12px;background:#0f1534;border-radius:999px;border:1px solid var(--chip-border);overflow:hidden}
    .progressFill{height:100%;width:0%;background:linear-gradient(90deg,var(--acc),#6ad1ff);transition:width .35s ease}
    .progressText{font-size:13px;color:var(--muted);margin-top:6px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    @media (max-width:640px){
      .progressText{font-size:12px}
    }

    /* Helpers */
    .small{font-size:12px;color:var(--muted)}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .loading{text-align:center;padding:20px;color:var(--muted)}
    .spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--chip-border);border-top-color:var(--acc);border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Mobile Menu Helper */
    @media (max-width:640px){
      .mobile-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img id="appLogo" alt="logo" src="https://dummyimage.com/128x128/1f2a52/ffffff&text=SE"/>
      <div>
        <h1 id="appTitle">Think Big Science Carnival 2025</h1>
        <small id="appSubtitle" class="muted">Project Evaluation System</small>
      </div>
    </div>
    <div id="userControls" aria-hidden="true"></div>
  </header>

  <div class="container">
    <!-- Role Gate -->
    <div id="roleGate" class="card">
      <h2>Choose Portal</h2>
      <p class="muted">Select your role to continue.</p>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn" onclick="UI.show('adminLogin')">Admin Panel</button>
        <button class="btn" onclick="UI.show('evaluatorLogin')">Evaluator Panel</button>
      </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" class="card hidden">
      <h2>Admin Login</h2>
      <div class="row">
        <div class="col-6">
          <label>Admin Email</label>
          <input id="adminEmail" placeholder="admin@example.com"/>
        </div>
        <div class="col-6">
          <label>Passcode</label>
          <input id="adminPass" type="password" placeholder="Enter admin passcode"/>
        </div>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn" onclick="Auth.adminLogin()">Login</button>
        <button class="btn secondary" onclick="UI.backToGate()">Back</button>
      </div>
      <div id="adminLoginMsg" class="hint"></div>
      <p class="hint" style="margin-top:8px">Default passcode is <b>admin123</b>. Change it in Settings.</p>
    </div>

    <!-- Evaluator Login -->
    <div id="evaluatorLogin" class="card hidden">
      <h2>Evaluator Login</h2>
      <div class="row">
        <div class="col-6">
          <label>Email</label>
          <input id="evalEmail" placeholder="you@school.org"/>
        </div>
        <div class="col-6">
          <label>Access Code</label>
          <input id="evalCode" placeholder="e.g. 742915"/>
        </div>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn" onclick="Auth.evaluatorLogin()">Login</button>
        <button class="btn secondary" onclick="UI.backToGate()">Back</button>
      </div>
      <div id="evalLoginMsg" class="hint"></div>
    </div>

    <!-- Admin App -->
    <div id="adminApp" class="card hidden">
      <div class="tabs mobile-scroll" id="adminTabs"></div>
      <div id="adminView"></div>
    </div>

    <!-- Evaluator App -->
    <div id="evalApp" class="hidden">
      <div id="evalTop" class="card flex-between">
        <div style="flex:1">
          <h3 id="welcomeTitle">Welcome to Think Big Science Carnival 2025</h3>
          <p id="welcomeBody" class="muted">Please review the instructions and enter your basic details to begin.</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div id="evalBadge" class="userBadge hidden"></div>
          <button class="headerLogout hidden" id="evalLogoutBtn" onclick="Auth.logoutEvaluator()">Logout</button>
        </div>
      </div>

      <div id="evalWelcome" class="card">
        <p class="muted">Please review the instructions and enter your basic details to begin.</p>
        <div style="margin-top:12px" class="toolbar">
          <button class="btn" onclick="Eval.showProfileForm()">Enter Your Basic Details</button>
        </div>
      </div>

      <!-- Profile Form -->
      <div id="evalProfile" class="card hidden">
        <h3>Your Details</h3>
        <div class="row">
          <div class="col-6">
            <label>Full Name *</label>
            <input id="profName"/>
          </div>
          <div class="col-6">
            <label>Expertise</label>
            <input id="profExpertise" placeholder="e.g. Robotics, Biology"/>
          </div>
          <div class="col-12">
            <label>Notes (optional)</label>
            <textarea id="profNotes" placeholder="Any additional information"></textarea>
          </div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn" onclick="Eval.saveProfile()">Save & Continue</button>
          <button class="btn secondary" onclick="UI.show('evalWelcome')">Cancel</button>
        </div>
        <div id="profMsg" class="hint"></div>
      </div>

      <!-- Assigned Projects -->
      <div id="evalProjects" class="card hidden">
        <h2>Your Assigned Projects</h2>
        <div class="hint">Select projects to evaluate. When ready click "Proceed to Finalize".</div>

        <!-- Progress bar + counter -->
        <div id="progressArea" class="progressWrap">
          <div class="progressBar"><div id="progressFill" class="progressFill" style="width:0%"></div></div>
          <div id="progressText" class="progressText">
            <span id="progressCount">0 / 0 completed (0%)</span>
            <span id="leftCount" class="small">0 left to evaluate</span>
          </div>
        </div>

        <div class="table-wrapper" style="margin-top:12px">
          <div id="evalProjectTable"></div>
        </div>

        <!-- Toolbar area -->
        <div id="evalToolbar" style="margin-top:12px" class="toolbar"></div>
      </div>

      <div id="modalContainer"></div>
    </div>
  </div>

  <script>
  /********************
   * GAS Configuration
   ********************/
  const GAS_CONFIG = {
    scriptUrl: '', // Set this in Admin Settings
    enabled: false
  };

  /********************
   * Store + GAS Sync
   ********************/
  const Store = {
    key: 'se_eval_app_v2',
    load(){
      try{
        const d = JSON.parse(localStorage.getItem(this.key)||'{}');
        const defaults = {
          settings:{
            eventTitle:'Think Big Science Carnival 2025',
            subtitle:'Project Evaluation System',
            welcomeTitle:'Welcome to Think Big Science Carnival 2025',
            welcomeBody:'Please read the instructions. Click below to enter your basic details and start evaluating assigned projects.',
            logoUrl:'https://dummyimage.com/128x128/1f2a52/ffffff&text=SE',
            adminPass:'admin123',
            gasUrl:''
          },
          evaluators:[],
          projects:[],
          panels:[],
          rubricDefs:[
            {key:'problem',label:'Problem Statement Clarity'},
            {key:'originality',label:'Originality'},
            {key:'description',label:'Project Description Quality'},
            {key:'method',label:'Methodology & Design'},
            {key:'impact',label:'Practical Application / Impact'},
            {key:'presentation',label:'Presentation & Q&A'}
          ],
          results:[],
          evaluatorState: {},
          lastSync: null
        };
        return Object.assign(defaults,d);
      }catch(err){
        console.error('Error loading data:',err);
        return this.load();
      }
    },
    save(){
      try{
        localStorage.setItem(this.key,JSON.stringify(DB));
        GASSync.autoSync();
      }catch(err){
        console.error('Error saving data:',err);
        alert('Error saving data. Please try again.');
      }
    }
  };
  let DB = Store.load();

  /********************
   * ID Migration - Convert old IDs to new format
   ********************/
  const IDMigration = {
    needsMigration(){
      // Check if any item has old-style ID
      const hasOldId = (arr) => arr.some(item => item.id && item.id.startsWith('id_'));
      return hasOldId(DB.projects) || hasOldId(DB.evaluators) || hasOldId(DB.panels) || hasOldId(DB.results);
    },
    
    migrate(){
      console.log('Starting ID migration...');
      
      // Create ID mapping for relationships
      const idMap = {
        projects: {},
        evaluators: {},
        panels: {},
        results: {}
      };
      
      // Migrate Projects
      DB.projects.forEach((p, idx) => {
        const oldId = p.id;
        const newId = `PRJ-${String(idx + 1).padStart(4, '0')}`;
        idMap.projects[oldId] = newId;
        p.id = newId;
      });
      
      // Migrate Evaluators
      DB.evaluators.forEach((e, idx) => {
        const oldId = e.id;
        const newId = `EVAL-${String(idx + 1).padStart(4, '0')}`;
        idMap.evaluators[oldId] = newId;
        e.id = newId;
      });
      
      // Migrate Panels and update references
      DB.panels.forEach((p, idx) => {
        const oldId = p.id;
        const newId = `PNL-${String(idx + 1).padStart(4, '0')}`;
        idMap.panels[oldId] = newId;
        p.id = newId;
        
        // Update evaluator references
        p.evaluatorIds = p.evaluatorIds.map(eid => idMap.evaluators[eid] || eid);
        
        // Update project references
        p.projectIds = p.projectIds.map(pid => idMap.projects[pid] || pid);
      });
      
      // Migrate Results and update references
      DB.results.forEach((r, idx) => {
        const oldId = r.id;
        const newId = `RES-${String(idx + 1).padStart(4, '0')}`;
        idMap.results[oldId] = newId;
        r.id = newId;
        
        // Update references
        r.panelId = idMap.panels[r.panelId] || r.panelId;
        r.projectId = idMap.projects[r.projectId] || r.projectId;
        r.evaluatorId = idMap.evaluators[r.evaluatorId] || r.evaluatorId;
      });
      
      // Update evaluator state keys
      if(DB.evaluatorState){
        const newState = {};
        for(let oldEvalId in DB.evaluatorState){
          const newEvalId = idMap.evaluators[oldEvalId] || oldEvalId;
          newState[newEvalId] = DB.evaluatorState[oldEvalId];
        }
        DB.evaluatorState = newState;
      }
      
      // Save migrated data
      Store.save();
      console.log('Migration complete!');
      
      alert('✓ IDs have been migrated to simple format!\n\nProjects: PRJ-0001, PRJ-0002...\nEvaluators: EVAL-0001, EVAL-0002...\nPanels: PNL-0001, PNL-0002...\nResults: RES-0001, RES-0002...\n\nPage will reload now.');
      location.reload();
    }
  };

  // Auto-migrate if needed
  if(IDMigration.needsMigration()){
    IDMigration.migrate();
  }

  /********************
   * GAS Sync Module
   ********************/
  const GASSync = {
    async push(type, data){
      if(!DB.settings.gasUrl){
        console.log('GAS URL not configured');
        return {ok:false, error:'No GAS URL'};
      }
      try{
        const payload = {type, data, timestamp:Date.now()};
        const res = await fetch(DB.settings.gasUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify(payload),
          redirect: 'follow'
        });
        
        // Note: no-cors mode means we can't read the response
        // We'll assume success if no error was thrown
        console.log('Data sent to GAS successfully');
        return {ok:true, note:'Request sent (no-cors mode)'};
      }catch(e){
        console.error('GAS sync failed:',e);
        return {ok:false, error:e.message};
      }
    },
    async syncAll(){
      if(!DB.settings.gasUrl){
        alert('⚠️ Please configure Google Apps Script URL in Admin Settings first.\n\nSteps:\n1. Create a Google Sheet\n2. Go to Extensions → Apps Script\n3. Copy the GAS code from HTML comments\n4. Deploy as Web App\n5. Paste URL in Settings');
        return {ok:false, error:'No GAS URL configured'};
      }
      UI.showLoading('Syncing to Google Sheets...');
      try{
        const result = await this.push('bulk',{
          settings:DB.settings,
          evaluators:DB.evaluators,
          projects:DB.projects,
          panels:DB.panels,
          results:DB.results,
          evaluatorState:DB.evaluatorState
        });
        UI.hideLoading();
        
        DB.lastSync = Date.now();
        localStorage.setItem(Store.key,JSON.stringify(DB));
        
        alert('✓ Data sent to Google Sheets!\n\nNote: Due to browser security (CORS), we cannot verify the response. Please check your Google Sheet to confirm the data was synced.');
        
        return result;
      }catch(err){
        UI.hideLoading();
        alert('✗ Sync error: '+err.message+'\n\nTroubleshooting:\n1. Make sure Web App is deployed as "Anyone"\n2. Use the correct deployment URL (ends with /exec)\n3. Check Google Sheet permissions');
        return {ok:false, error:err.message};
      }
    },
    async syncResult(result){
      if(!DB.settings.gasUrl) return {ok:false};
      try{
        return await this.push('result',result);
      }catch(e){
        console.warn('Result sync failed:',e);
        return {ok:false};
      }
    },
    autoSync(){
      // Auto-sync every 5 minutes if GAS URL is configured
      if(DB.settings.gasUrl && DB.lastSync && (Date.now()-DB.lastSync > 300000)){
        this.syncAll();
      }
    }
  };

  /********************
   * Utilities
   ********************/
  const U = {
    uid:(type='item')=>{
      const prefix = {
        project:'PRJ',
        evaluator:'EVAL',
        panel:'PNL',
        result:'RES'
      }[type] || 'ID';
      
      // Get current count based on existing items
      let count = 0;
      if(type === 'project') count = DB.projects.length + 1;
      else if(type === 'evaluator') count = DB.evaluators.length + 1;
      else if(type === 'panel') count = DB.panels.length + 1;
      else if(type === 'result') count = DB.results.length + 1;
      
      const num = String(count).padStart(4,'0');
      return `${prefix}-${num}`;
    },
    el:(html)=>{const t=document.createElement('template');t.innerHTML=html.trim();return t.content.firstChild},
    fmtDate:(ts)=> new Date(ts).toLocaleString(),
    download(name, obj){
      const blob = new Blob([typeof obj==='string'?obj:JSON.stringify(obj,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);const a = document.createElement('a');a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);
    },
    csv(rows){
      const keys=[...new Set(rows.flatMap(r=>Object.keys(r)))];
      const esc=(v)=>(''+(v??'')).replaceAll('"','""');
      const out=[keys.join(',')].concat(rows.map(r=>keys.map(k=>`"${esc(r[k])}"`).join(',')));
      return out.join('\n');
    }
  };

  /********************
   * UI Module
   ********************/
  const UI = {
    show(id){
      document.querySelectorAll('.card, #evalApp, #adminApp').forEach(el=>{
        if(el.id===id) el.classList.remove('hidden'); 
        else {
          if(el.id==='evalApp' && id.startsWith('eval')) el.classList.remove('hidden'); 
          else el.classList.add('hidden');
        }
      });
      if(id==='evalApp' || id.startsWith('eval')) document.getElementById('evalApp').classList.remove('hidden');
      this.syncBranding();
    },
    backToGate(){
      ['adminEmail','adminPass','evalEmail','evalCode'].forEach(id=>{const el=document.getElementById(id); if(el) el.value=''});
      Auth.currentAdmin=null;
      document.querySelectorAll('.card, #evalApp, #adminApp').forEach(el=>el.classList.add('hidden'));
      document.getElementById('roleGate').classList.remove('hidden');
      this.syncBranding();
    },
    syncBranding(){
      document.getElementById('appTitle').textContent = DB.settings.eventTitle;
      document.getElementById('appSubtitle').textContent = DB.settings.subtitle;
      document.getElementById('appLogo').src = DB.settings.logoUrl || 'https://dummyimage.com/128x128/1f2a52/ffffff&text=SE';
      document.getElementById('welcomeTitle').textContent = DB.settings.welcomeTitle;
      document.getElementById('welcomeBody').textContent = DB.settings.welcomeBody;

      const uc = document.getElementById('userControls'); uc.innerHTML='';
      if(Auth.currentAdmin){
        uc.style.display='flex';
        uc.appendChild(U.el(`<div class="userBadge">Admin: ${Auth.currentAdmin.email||'—'}</div>`));
        const btn = U.el(`<button class="headerLogout">Logout</button>`); btn.onclick=()=>Auth.logoutAdmin(); uc.appendChild(btn);
        return;
      }
      if(Auth.currentEval){
        uc.style.display='flex';
        uc.appendChild(U.el(`<div class="userBadge">${Auth.currentEval.name||Auth.currentEval.email||'Evaluator'}</div>`));
        const btn = U.el(`<button class="headerLogout">Logout</button>`); btn.onclick=()=>Auth.logoutEvaluator(); uc.appendChild(btn);
        const eb = document.getElementById('evalBadge'); if(eb){ eb.textContent = Auth.currentEval.name || Auth.currentEval.email; eb.classList.remove('hidden'); }
        const ebbtn = document.getElementById('evalLogoutBtn'); if(ebbtn) ebbtn.classList.remove('hidden');
        return;
      }
      uc.style.display='none';
      const eb = document.getElementById('evalBadge'); if(eb) eb.classList.add('hidden');
      const ebbtn = document.getElementById('evalLogoutBtn'); if(ebbtn) ebbtn.classList.add('hidden');
    },
    showLoading(msg='Loading...'){
      const existing = document.getElementById('globalLoading');
      if(existing) existing.remove();
      const loader = U.el(`<div id="globalLoading" style="position:fixed;top:70px;right:16px;background:var(--card);border:1px solid var(--border);padding:12px 16px;border-radius:10px;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.3)"><div style="display:flex;align-items:center;gap:10px"><span class="spinner"></span><span>${msg}</span></div></div>`);
      document.body.appendChild(loader);
    },
    hideLoading(){
      const loader = document.getElementById('globalLoading');
      if(loader) loader.remove();
    }
  };

  /********************
   * Auth Module
   ********************/
  const Auth = {
    currentAdmin:null,
    currentEval:null,
    adminLogin(){
      const email = document.getElementById('adminEmail').value.trim();
      const pass = document.getElementById('adminPass').value.trim();
      const msg = document.getElementById('adminLoginMsg');
      if(pass === DB.settings.adminPass){
        this.currentAdmin = {email}; UI.show('adminApp'); Admin.render(); msg.textContent=''; UI.syncBranding();
      } else { msg.textContent = 'Invalid passcode.'; msg.style.color='var(--bad)'; }
    },
    async evaluatorLogin(){
      const email = document.getElementById('evalEmail').value.trim();
      const code = document.getElementById('evalCode').value.trim();
      const ev = DB.evaluators.find(e=>e.email===email && String(e.code)===String(code));
      const msg = document.getElementById('evalLoginMsg');
      if(ev){
        this.currentEval = ev; UI.show('evalApp'); UI.show('evalWelcome'); UI.syncBranding();
      } else { msg.textContent = 'No evaluator found for that email & code.'; msg.style.color='var(--bad)'; }
    },
    logoutAdmin(){
      if(!confirm('Logout admin?')) return;
      this.currentAdmin = null; UI.backToGate();
    },
    logoutEvaluator(){
      if(!confirm('Logout evaluator?')) return;
      this.currentEval = null;
      document.getElementById('profName').value=''; 
      document.getElementById('profExpertise').value=''; 
      document.getElementById('profNotes').value='';
      document.getElementById('evalProjectTable').innerHTML='';
      UI.backToGate();
    }
  };

  /********************
   * Admin Module
   ********************/
  const Admin = {
    tabs:[
      {id:'scores',label:'Scores'},
      {id:'settings',label:'Settings'},
      {id:'projects',label:'Projects'},
      {id:'evaluators',label:'Evaluators'},
      {id:'panels',label:'Jury Panels'},
      {id:'data',label:'Data & Export'}
    ],
    render(){
      const tabs = document.getElementById('adminTabs');
      tabs.innerHTML='';
      this.tabs.forEach((t,i)=>{
        const b=U.el(`<button class="tab ${i===0?'active':''}" data-id="${t.id}">${t.label}</button>`);
        b.onclick=(e)=>this.switch(e.target.getAttribute('data-id'));
        tabs.appendChild(b);
      });
      this.switch('scores');
      UI.syncBranding();
    },
    switch(id){
      document.querySelectorAll('#adminTabs .tab').forEach(tb=>tb.classList.remove('active'));
      const targetTab = document.querySelector(`#adminTabs .tab[data-id="${id}"]`);
      if(targetTab) targetTab.classList.add('active');
      const v = document.getElementById('adminView');
      this[id](v);
      UI.syncBranding();
    },

    /* SCORES */
    scores(host){
      // Calculate aggregated scores for each project
      const projectScores = DB.projects.map(project => {
        const projectResults = DB.results.filter(r => r.projectId === project.id);
        
        if (projectResults.length === 0) {
          return {
            id: project.id,
            title: project.title,
            category: project.category || '—',
            team: project.team || '—',
            school: project.school || '—',
            evaluatorCount: 0,
            totalScore: 0,
            averageScore: 0,
            maxPossible: DB.rubricDefs.length * 10,
            percentage: 0,
            evaluators: []
          };
        }

        const totalScore = projectResults.reduce((sum, r) => sum + (r.total || 0), 0);
        const averageScore = totalScore / projectResults.length;
        const maxPossible = DB.rubricDefs.length * 10;
        const percentage = (averageScore / maxPossible) * 100;

        // Get evaluator details
        const evaluators = projectResults.map(r => {
          const evaluator = DB.evaluators.find(e => e.id === r.evaluatorId);
          return {
            name: evaluator?.name || evaluator?.email || 'Unknown',
            score: r.total || 0,
            finalized: r.finalizedByEvaluator
          };
        });

        return {
          id: project.id,
          title: project.title,
          category: project.category || '—',
          team: project.team || '—',
          school: project.school || '—',
          evaluatorCount: projectResults.length,
          totalScore: totalScore,
          averageScore: averageScore,
          maxPossible: maxPossible,
          percentage: percentage,
          evaluators: evaluators
        };
      });

      // Sort by average score (descending)
      projectScores.sort((a, b) => b.averageScore - a.averageScore);

      // Generate table rows with highlighting for top 5
      const rows = projectScores.map((ps, index) => {
        const isTop5 = index < 5 && ps.evaluatorCount > 0;
        const rowStyle = isTop5 ? 'background: linear-gradient(90deg, #1a2454, #0f1534); border-left: 4px solid #7c9cff;' : '';
        const badge = isTop5 ? `<span class="pill" style="background:#7c9cff;color:#000;font-weight:700">TOP ${index + 1}</span>` : '';

        const evalDetails = ps.evaluators.length > 0 
          ? ps.evaluators.map(e => `${e.name}: <b>${e.score}</b>${e.finalized ? ' ✓' : ''}`).join('<br>')
          : '<span class="muted">No evaluations yet</span>';

        return `<tr style="${rowStyle}">
          <td>
            ${badge}
            ${badge ? '<br>' : ''}
            <b>${ps.title}</b>
            <div class="hint" style="margin-top:4px">${ps.category}</div>
          </td>
          <td>${ps.team}<div class="hint">${ps.school}</div></td>
          <td style="text-align:center">
            <span class="pill">${ps.evaluatorCount} evaluator${ps.evaluatorCount !== 1 ? 's' : ''}</span>
          </td>
          <td style="text-align:right">
            <b style="font-size:18px;color:${isTop5 ? 'var(--acc)' : 'inherit'}">${ps.averageScore.toFixed(2)}</b>
            <div class="hint">out of ${ps.maxPossible}</div>
          </td>
          <td style="text-align:right">
            <b style="font-size:16px;color:${ps.percentage >= 80 ? 'var(--good)' : ps.percentage >= 60 ? '#fbbf24' : 'inherit'}">${ps.percentage.toFixed(1)}%</b>
          </td>
          <td>
            <button class="btn" onclick="Admin.viewProjectDetails('${ps.id}')">View Details</button>
          </td>
        </tr>`;
      }).join('');

      const evaluatedProjects = projectScores.filter(ps => ps.evaluatorCount > 0);
      const avgScore = evaluatedProjects.length > 0 
        ? (evaluatedProjects.reduce((sum, ps) => sum + ps.averageScore, 0) / evaluatedProjects.length).toFixed(2)
        : '—';

      const summary = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
          <div class="card" style="background:#1a2454">
            <div class="hint">Total Projects</div>
            <div style="font-size:28px;font-weight:700;margin-top:4px">${DB.projects.length}</div>
          </div>
          <div class="card" style="background:#1a2454">
            <div class="hint">Projects Evaluated</div>
            <div style="font-size:28px;font-weight:700;margin-top:4px">${evaluatedProjects.length}</div>
          </div>
          <div class="card" style="background:#1a2454">
            <div class="hint">Total Evaluations</div>
            <div style="font-size:28px;font-weight:700;margin-top:4px">${DB.results.length}</div>
          </div>
          <div class="card" style="background:#1a2454">
            <div class="hint">Average Score</div>
            <div style="font-size:28px;font-weight:700;margin-top:4px">${avgScore}</div>
          </div>
        </div>
      `;

      host.innerHTML = `
        ${summary}
        <div class="card">
          <div class="flex-between" style="margin-bottom:12px">
            <h3>Project Scores (Ranked by Average)</h3>
            <div class="toolbar">
              <button class="btn" onclick="Admin.exportScores()">Export Scores</button>
              <button class="btn danger" onclick="Admin.clearScores()">Clear All Scores</button>
              <button class="btn secondary" onclick="Admin.refreshScores()">Refresh</button>
            </div>
          </div>
          <div class="hint" style="margin-bottom:12px">
            Top 5 projects are highlighted. Scores are averaged from all evaluator submissions.
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Team</th>
                  <th>Evaluations</th>
                  <th style="text-align:right">Avg Score</th>
                  <th style="text-align:right">Percentage</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows || '<tr><td colspan="6" class="muted" style="text-align:center;padding:20px">No projects or evaluations yet.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    },

    viewProjectDetails(projectId){
      const project = DB.projects.find(p => p.id === projectId);
      if (!project) {
        alert('Project not found');
        return;
      }

      const projectResults = DB.results.filter(r => r.projectId === projectId);
      
      if (projectResults.length === 0) {
        alert('No evaluations found for this project');
        return;
      }

      // Calculate aggregate scores for each rubric criterion
      const rubricAggregates = {};
      DB.rubricDefs.forEach(def => {
        const scores = projectResults.map(r => r.scores?.[def.key] || 0);
        const sum = scores.reduce((a, b) => a + b, 0);
        const avg = sum / scores.length;
        rubricAggregates[def.key] = {
          label: def.label,
          scores: scores,
          average: avg,
          max: 10
        };
      });

      const totalAvg = Object.values(rubricAggregates).reduce((sum, agg) => sum + agg.average, 0);
      const maxTotal = DB.rubricDefs.length * 10;
      const percentage = (totalAvg / maxTotal) * 100;

      // Generate detailed rows
      const evaluatorRows = projectResults.map(r => {
        const evaluator = DB.evaluators.find(e => e.id === r.evaluatorId);
        const evalName = evaluator?.name || evaluator?.email || 'Unknown';
        
        const scoreBreakdown = DB.rubricDefs.map(def => 
          `<div style="margin:4px 0"><span class="hint">${def.label}:</span> <b>${r.scores?.[def.key] || 0}</b>/10</div>`
        ).join('');

        return `
          <div class="card" style="margin-bottom:10px">
            <div class="flex-between">
              <div>
                <b>${evalName}</b>
                ${r.finalizedByEvaluator ? '<span class="pill success" style="margin-left:8px">✓ Finalized</span>' : '<span class="pill" style="margin-left:8px">Draft</span>'}
              </div>
              <div style="text-align:right">
                <div style="font-size:20px;font-weight:700">${r.total || 0}</div>
                <div class="hint">out of ${maxTotal}</div>
              </div>
            </div>
            <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
              ${scoreBreakdown}
            </div>
            ${r.remark ? `<div style="margin-top:12px;padding:10px;background:#0e1430;border-radius:8px;border:1px solid var(--chip-border)"><div class="hint">Remark:</div>${r.remark}</div>` : ''}
          </div>
        `;
      }).join('');

      const aggregateTable = `
        <table>
          <thead>
            <tr>
              <th>Criterion</th>
              <th style="text-align:right">Average Score</th>
              <th style="text-align:right">Individual Scores</th>
            </tr>
          </thead>
          <tbody>
            ${DB.rubricDefs.map(def => {
              const agg = rubricAggregates[def.key];
              return `<tr>
                <td>${agg.label}</td>
                <td style="text-align:right"><b style="font-size:16px">${agg.average.toFixed(2)}</b> / 10</td>
                <td style="text-align:right">${agg.scores.join(', ')}</td>
              </tr>`;
            }).join('')}
            <tr style="background:#1a2454;font-weight:700">
              <td>TOTAL</td>
              <td style="text-align:right;font-size:18px;color:var(--acc)">${totalAvg.toFixed(2)} / ${maxTotal}</td>
              <td style="text-align:right;font-size:16px">${percentage.toFixed(1)}%</td>
            </tr>
          </tbody>
        </table>
      `;

      const dlg = U.el(`
        <div class="modal-wrap">
          <div class="modal" style="max-width:1100px">
            <h2>${project.title}</h2>
            <div class="hint" style="margin-bottom:16px">
              <b>Team:</b> ${project.team || '—'} | <b>School:</b> ${project.school || '—'} | <b>Category:</b> ${project.category || '—'}
            </div>

            <h3 style="margin-top:20px">Score Summary</h3>
            <div class="card">
              ${aggregateTable}
            </div>

            <h3 style="margin-top:20px">Individual Evaluations (${projectResults.length})</h3>
            ${evaluatorRows}

            <div class="toolbar" style="margin-top:16px">
              <button class="btn secondary" id="closeDetails">Close</button>
            </div>
          </div>
        </div>
      `);

      document.body.appendChild(dlg);
      dlg.querySelector('#closeDetails').onclick = () => dlg.remove();
    },

    exportScores(){
      const projectScores = DB.projects.map(project => {
        const projectResults = DB.results.filter(r => r.projectId === project.id);
        
        if (projectResults.length === 0) {
          return {
            'Project ID': project.id,
            'Project Title': project.title,
            'Category': project.category || '',
            'Team': project.team || '',
            'School': project.school || '',
            'Number of Evaluators': 0,
            'Average Score': 0,
            'Max Possible': DB.rubricDefs.length * 10,
            'Percentage': 0
          };
        }

        const totalScore = projectResults.reduce((sum, r) => sum + (r.total || 0), 0);
        const averageScore = totalScore / projectResults.length;
        const maxPossible = DB.rubricDefs.length * 10;
        const percentage = (averageScore / maxPossible) * 100;

        return {
          'Project ID': project.id,
          'Project Title': project.title,
          'Category': project.category || '',
          'Team': project.team || '',
          'School': project.school || '',
          'Number of Evaluators': projectResults.length,
          'Average Score': averageScore.toFixed(2),
          'Max Possible': maxPossible,
          'Percentage': percentage.toFixed(1) + '%'
        };
      });

      // Sort by average score
      projectScores.sort((a, b) => parseFloat(b['Average Score']) - parseFloat(a['Average Score']));

      U.download('project_scores.csv', U.csv(projectScores));
      alert('✓ Scores exported successfully!');
    },

    refreshScores(){
      this.scores(document.getElementById('adminView'));
    },

    clearScores(){
      if(!confirm('⚠️ WARNING: This will delete ALL evaluation scores and results.\n\nProjects, evaluators, and panels will remain intact.\n\nProceed with deleting all scores?')) return;
      if(!confirm('⚠️ FINAL CONFIRMATION\n\nDelete all evaluation results?\n\nThis cannot be undone!')) return;
      
      DB.results = [];
      DB.evaluatorState = {};
      
      Store.save();
      alert('✓ All scores have been cleared successfully.\n\nProjects, evaluators, and panels are still available.\n\nEvaluators can now start fresh evaluations.');
      this.scores(document.getElementById('adminView'));
    },

    /* SETTINGS */
    settings(host){
      const syncStatus = DB.lastSync ? `Last synced: ${U.fmtDate(DB.lastSync)}` : 'Never synced';
      host.innerHTML = `
        <div class="row">
          <div class="col-6 card">
            <h3>Branding & Content</h3>
            <label>Event Title</label>
            <input id="setEventTitle" value="${DB.settings.eventTitle}">
            <label>Subtitle</label>
            <input id="setSubtitle" value="${DB.settings.subtitle}">
            <label>Logo URL</label>
            <input id="setLogo" value="${DB.settings.logoUrl}">
            <label>Welcome Title</label>
            <input id="setWelcomeTitle" value="${DB.settings.welcomeTitle}">
            <label>Welcome Body</label>
            <textarea id="setWelcomeBody">${DB.settings.welcomeBody}</textarea>
            <div class="toolbar" style="margin-top:10px">
              <button class="btn" onclick="Admin.saveSettings()">Save</button>
              <button class="btn secondary" onclick="Admin.resetBranding()">Reset Defaults</button>
            </div>
          </div>

          <div class="col-6 card">
            <h3>Security & GAS Integration</h3>
            <label>Admin Passcode</label>
            <input id="setAdminPass" type="password" value="${DB.settings.adminPass}">
            <label>Google Apps Script Web App URL</label>
            <input id="setGasUrl" placeholder="https://script.google.com/macros/s/.../exec" value="${DB.settings.gasUrl||''}">
            <div class="hint">Deploy your GAS as a Web App and paste the URL here. Data will sync automatically.</div>
            <div class="hint" style="margin-top:4px;color:var(--acc)">${syncStatus}</div>
            <div class="toolbar" style="margin-top:10px">
              <button class="btn" onclick="Admin.saveSettings()">Save</button>
              <button class="btn" onclick="GASSync.syncAll()">Sync Now</button>
            </div>
            
            <h3 style="margin-top:20px">System Tools</h3>
            <div class="hint">Use these tools to manage your system data.</div>
            <div class="toolbar" style="margin-top:10px">
              <button class="btn secondary" onclick="Admin.migrateIDs()">Fix IDs to Simple Format</button>
              <button class="btn danger" onclick="Admin.resetAllData()">Reset All Data</button>
            </div>
          </div>
        </div>
      `;
    },
    saveSettings(){
      DB.settings.eventTitle=document.getElementById('setEventTitle').value.trim();
      DB.settings.subtitle=document.getElementById('setSubtitle').value.trim();
      DB.settings.logoUrl=document.getElementById('setLogo').value.trim();
      DB.settings.welcomeTitle=document.getElementById('setWelcomeTitle').value.trim();
      DB.settings.welcomeBody=document.getElementById('setWelcomeBody').value.trim();
      DB.settings.adminPass=document.getElementById('setAdminPass').value.trim();
      DB.settings.gasUrl=document.getElementById('setGasUrl').value.trim();
      Store.save(); UI.syncBranding(); alert('✓ Settings saved!');
    },
    resetBranding(){
      if(!confirm('Reset all branding to defaults?')) return;
      DB.settings.eventTitle='Think Big Science Carnival 2025';
      DB.settings.subtitle='Project Evaluation System';
      DB.settings.logoUrl='https://dummyimage.com/128x128/1f2a52/ffffff&text=SE';
      DB.settings.welcomeTitle='Welcome to Think Big Science Carnival 2025';
      DB.settings.welcomeBody='Please read the instructions. Click below to enter your basic details and start evaluating assigned projects.';
      Store.save(); this.settings(document.getElementById('adminView')); UI.syncBranding();
    },

    resetAllData(){
      if(!confirm('⚠️ WARNING: This will permanently delete ALL DATA including:\n\n• All Projects\n• All Evaluators\n• All Panels\n• All Evaluation Results\n• All Scores\n\nThis action CANNOT be undone!\n\nClick OK to proceed with deletion.')) return;
      if(!confirm('⚠️ FINAL CONFIRMATION\n\nAre you absolutely sure you want to delete everything?\n\nThis is your last chance to cancel!')) return;
      
      // Clear all data except settings
      DB.evaluators = [];
      DB.projects = [];
      DB.panels = [];
      DB.results = [];
      DB.evaluatorState = {};
      
      Store.save();
      alert('✓ All data has been deleted successfully.\n\nThe system has been reset to empty state.\n\nYou can now add new projects, evaluators, and panels.');
      this.switch('scores');
    },

    /* PROJECTS */
    projects(host){
      const list = DB.projects.map(p=>`
        <tr>
          <td><b>${p.title}</b><div class="hint">${p.category||''}</div></td>
          <td>${p.team||''}</td>
          <td>${p.school||''}</td>
          <td>${p.contact||''}</td>
          <td>
            <div class="toolbar">
              <button class="btn" onclick="Admin.editProject('${p.id}')">Edit</button>
              <button class="btn danger" onclick="Admin.deleteProject('${p.id}')">Delete</button>
            </div>
          </td>
        </tr>`).join('');

      host.innerHTML = `
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" onclick="Admin.editProject()">Add Project</button>
        </div>
        <div class="card">
          <h3>Projects (${DB.projects.length})</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Project</th><th>Team</th><th>School</th><th>Contact</th><th>Actions</th></tr></thead>
              <tbody>${list||'<tr><td colspan="5" class="muted" style="text-align:center;padding:20px">No projects yet.</td></tr>'}</tbody>
            </table>
          </div>
        </div>
      `;
    },
    editProject(id){
      const p = id ? DB.projects.find(x=>x.id===id) : {id:U.uid('project'),title:'',category:'',team:'',school:'',contact:''};
      const dlg = U.el(`
        <div class="modal-wrap">
          <div class="modal">
            <h3>${id?'Edit':'Add'} Project</h3>
            <div class="hint" style="margin-bottom:12px">ID: <b>${p.id}</b></div>
            <label>Title *</label><input id="p_title" value="${p.title}">
            <label>Category</label><input id="p_cat" value="${p.category}" placeholder="e.g. IoT, AI/ML, Environment">
            <label>Team Name</label><input id="p_team" value="${p.team}">
            <label>School</label><input id="p_school" value="${p.school}">
            <label>Contact</label><input id="p_contact" value="${p.contact}" placeholder="email or phone">
            <div class="toolbar" style="margin-top:12px">
              <button class="btn" id="saveBtn">Save</button>
              <button class="btn secondary" id="cancelBtn">Cancel</button>
            </div>
          </div>
        </div>`);
      document.body.appendChild(dlg);
      dlg.querySelector('#cancelBtn').onclick=()=>dlg.remove();
      dlg.querySelector('#saveBtn').onclick=()=>{
        p.title=dlg.querySelector('#p_title').value.trim();
        p.category=dlg.querySelector('#p_cat').value.trim();
        p.team=dlg.querySelector('#p_team').value.trim();
        p.school=dlg.querySelector('#p_school').value.trim();
        p.contact=dlg.querySelector('#p_contact').value.trim();
        if(!p.title){alert('Title is required');return}
        if(!id) DB.projects.push(p);
        Store.save(); dlg.remove(); Admin.projects(document.getElementById('adminView'))
      }
      dlg.querySelector('#p_title').focus();
    },
    deleteProject(id){
      if(!confirm('Delete this project? This will also remove it from all panels.')) return;
      DB.projects = DB.projects.filter(p=>p.id!==id);
      DB.panels.forEach(pa=>pa.projectIds=pa.projectIds.filter(pid=>pid!==id));
      Store.save(); this.projects(document.getElementById('adminView'))
    },

    /* EVALUATORS */
    evaluators(host){
      const list = DB.evaluators.map(e=>`
        <tr>
          <td><b>${e.name||'(no name)'}</b><div class="hint">${e.email}</div></td>
          <td>${e.expertise||'—'}</td>
          <td><span class="pill">Code: ${e.code}</span></td>
          <td>
            <div class="toolbar">
              <button class="btn" onclick="Admin.editEvaluator('${e.id}')">Edit</button>
              <button class="btn danger" onclick="Admin.deleteEvaluator('${e.id}')">Delete</button>
            </div>
          </td>
        </tr>`).join('');

      host.innerHTML = `
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" onclick="Admin.bulkAddEvaluators()">Quick Add (CSV)</button>
          <button class="btn" onclick="Admin.editEvaluator()">Add Evaluator</button>
        </div>
        <div class="card">
          <h3>Evaluators (${DB.evaluators.length})</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Evaluator</th><th>Expertise</th><th>Access Code</th><th>Actions</th></tr></thead>
              <tbody>${list||'<tr><td colspan="4" class="muted" style="text-align:center;padding:20px">No evaluators yet.</td></tr>'}</tbody>
            </table>
          </div>
        </div>
      `;
    },
    editEvaluator(id){
      const e = id ? DB.evaluators.find(x=>x.id===id) : {id:U.uid('evaluator'),name:'',email:'',expertise:'',notes:'',code:Math.floor(100000+Math.random()*900000)};
      const dlg = U.el(`
        <div class="modal-wrap">
          <div class="modal">
            <h3>${id?'Edit':'Add'} Evaluator</h3>
            <div class="hint" style="margin-bottom:12px">ID: <b>${e.id}</b></div>
            <label>Name *</label><input id="e_name" value="${e.name}">
            <label>Email *</label><input id="e_email" value="${e.email}" type="email">
            <label>Expertise</label><input id="e_ex" value="${e.expertise}" placeholder="e.g. Robotics, AI">
            <label>Access Code</label><input id="e_code" value="${e.code}">
            <label>Notes</label><textarea id="e_notes">${e.notes||''}</textarea>
            <div class="toolbar" style="margin-top:12px">
              <button class="btn" id="saveBtn">Save</button>
              <button class="btn secondary" id="cancelBtn">Cancel</button>
            </div>
          </div>
        </div>`);
      document.body.appendChild(dlg);
      dlg.querySelector('#cancelBtn').onclick=()=>dlg.remove();
      dlg.querySelector('#saveBtn').onclick=()=>{
        e.name=dlg.querySelector('#e_name').value.trim();
        e.email=dlg.querySelector('#e_email').value.trim();
        e.expertise=dlg.querySelector('#e_ex').value.trim();
        e.code=dlg.querySelector('#e_code').value.trim();
        e.notes=dlg.querySelector('#e_notes').value.trim();
        if(!e.email){alert('Email required');return}
        if(!e.name){alert('Name required');return}
        if(!id) DB.evaluators.push(e);
        Store.save(); dlg.remove(); Admin.evaluators(document.getElementById('adminView'))
      }
      dlg.querySelector('#e_name').focus();
    },
    deleteEvaluator(id){
      if(!confirm('Delete this evaluator? This will also remove them from all panels.')) return;
      DB.evaluators = DB.evaluators.filter(e=>e.id!==id);
      DB.panels.forEach(pa=>pa.evaluatorIds=pa.evaluatorIds.filter(eid=>eid!==id));
      Store.save(); this.evaluators(document.getElementById('adminView'))
    },
    bulkAddEvaluators(){
      const sample = 'name,email,expertise\nJane Doe,jane@ex.com,Robotics\nJohn Smith,john@ex.com,Biology';
      const text = prompt('Paste CSV with columns: name,email,expertise\n\nExample:\n'+sample, '');
      if(!text) return;
      const lines=text.split(/\r?\n/).filter(Boolean); 
      if(lines.length<2){alert('Need at least header + 1 data row');return}
      const head=lines.shift().split(',').map(h=>h.trim());
      let added=0;
      lines.forEach(line=>{
        const cols=line.split(',');
        if(cols.length<2) return;
        const e={id:U.uid('evaluator'),code:Math.floor(100000+Math.random()*900000),notes:''};
        head.forEach((h,i)=>e[h]=cols[i]?.trim()||'');
        if(e.email){
          DB.evaluators.push(e);
          added++;
        }
      });
      Store.save(); 
      alert(`Added ${added} evaluators`);
      this.evaluators(document.getElementById('adminView'))
    },

    /* PANELS */
    panels(host){
      const list = DB.panels.map(pa=>{
        const evaluators = pa.evaluatorIds.map(id=>DB.evaluators.find(e=>e.id===id)).filter(e=>e);
        const projects = pa.projectIds.map(id=>DB.projects.find(p=>p.id===id)).filter(p=>p);
        
        const evalNames = evaluators.map(e=>e.name||e.email).join(', ');
        const projTitles = projects.map(p=>p.title).join(', ');
        
        const evalCount = evaluators.length;
        const projCount = projects.length;
        
        return `<tr>
          <td>
            <b>${pa.name}</b>
            <div class="hint" style="margin-top:4px">${pa.id}</div>
          </td>
          <td>
            <span class="pill">${evalCount} member${evalCount !== 1 ? 's' : ''}</span>
            <div class="hint" style="margin-top:4px">${evalNames||'<span class="muted">none</span>'}</div>
          </td>
          <td>
            <span class="pill">${projCount} project${projCount !== 1 ? 's' : ''}</span>
            <div class="hint" style="margin-top:4px">${projTitles||'<span class="muted">none</span>'}</div>
          </td>
          <td>
            <div class="toolbar">
              <button class="btn" onclick="Admin.editPanel('${pa.id}')">Edit</button>
              <button class="btn danger" onclick="Admin.deletePanel('${pa.id}')">Delete</button>
            </div>
          </td>
        </tr>`
      }).join('');

      host.innerHTML = `
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" onclick="Admin.editPanel()">Create Panel</button>
        </div>
        <div class="card">
          <h3>Jury Panels (${DB.panels.length})</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Panel</th><th>Evaluators</th><th>Projects</th><th>Actions</th></tr></thead>
              <tbody>${list||'<tr><td colspan="4" class="muted" style="text-align:center;padding:20px">No panels yet.</td></tr>'}</tbody>
            </table>
          </div>
        </div>
      `;
    },
    editPanel(id){
      const pa = id ? DB.panels.find(x=>x.id===id) : {id:U.uid('panel'),name:'Panel '+(DB.panels.length+1),evaluatorIds:[],projectIds:[]};
      const evalOpts = DB.evaluators.map(e=>`<label class="chip" style="cursor:pointer"><input type="checkbox" data-eid value="${e.id}" style="width:auto;margin-right:6px"> ${e.name||e.email}</label>`).join(' ');
      const projOpts = DB.projects.map(p=>`<label class="chip" style="cursor:pointer"><input type="checkbox" data-pid value="${p.id}" style="width:auto;margin-right:6px"> ${p.title}</label>`).join(' ');
      const dlg = U.el(`
        <div class="modal-wrap">
          <div class="modal">
            <h3>${id?'Edit':'Create'} Jury Panel</h3>
            <div class="hint" style="margin-bottom:12px">ID: <b>${pa.id}</b></div>
            <label>Panel Name</label><input id="pa_name" value="${pa.name}">
            <label>Evaluators (select 3–4) *</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px">${evalOpts||'<div class="muted">Add evaluators first.</div>'}</div>
            <label style="margin-top:10px">Projects to Evaluate *</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px">${projOpts||'<div class="muted">Add projects first.</div>'}</div>
            <div class="toolbar" style="margin-top:12px">
              <button class="btn" id="saveBtn">Save Panel</button>
              <button class="btn secondary" id="cancelBtn">Cancel</button>
            </div>
          </div>
        </div>`);
      document.body.appendChild(dlg);
      dlg.querySelectorAll('[data-eid]').forEach(ch=>{ch.checked = pa.evaluatorIds.includes(ch.value)});
      dlg.querySelectorAll('[data-pid]').forEach(ch=>{ch.checked = pa.projectIds.includes(ch.value)});
      dlg.querySelector('#cancelBtn').onclick=()=>dlg.remove();
      dlg.querySelector('#saveBtn').onclick=()=>{
        pa.name=dlg.querySelector('#pa_name').value.trim()||pa.name;
        pa.evaluatorIds=[...dlg.querySelectorAll('[data-eid]:checked')].map(x=>x.value);
        pa.projectIds=[...dlg.querySelectorAll('[data-pid]:checked')].map(x=>x.value);
        if(pa.evaluatorIds.length<3 || pa.evaluatorIds.length>4){alert('Select 3–4 evaluators for a jury panel.');return}
        if(pa.projectIds.length===0){alert('Assign at least one project.');return}
        if(!id) DB.panels.push(pa);
        Store.save(); dlg.remove(); Admin.panels(document.getElementById('adminView'))
      }
    },
    deletePanel(id){
      if(!confirm('Delete this panel?')) return;
      DB.panels = DB.panels.filter(p=>p.id!==id);
      Store.save(); this.panels(document.getElementById('adminView'))
    },

    /* DATA */
    data(host){
      const rows = DB.results.map(r=>({
        id:r.id,
        panel:DB.panels.find(p=>p.id===r.panelId)?.name||'—',
        project:DB.projects.find(p=>p.id===r.projectId)?.title||'—',
        evaluator:DB.evaluators.find(e=>e.id===r.evaluatorId)?.name||'—',
        total:r.total, 
        remark:r.remark, 
        finalized:r.finalizedByEvaluator?'Yes':'No',
        time:U.fmtDate(r.ts), 
        ...r.scores
      }));
      host.innerHTML = `
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" onclick='U.download("results.json", DB.results)'>Download JSON</button>
          <button class="btn" onclick='U.download("results.csv", U.csv(${JSON.stringify(rows)}))'>Download CSV</button>
          <button class="btn" onclick="GASSync.syncAll()">Sync to Google Sheets</button>
        </div>
        <div class="card">
          <h3>Evaluation Results (${DB.results.length})</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>ID</th><th>Panel</th><th>Project</th><th>Evaluator</th><th>Total</th><th>Finalized</th><th>Time</th></tr></thead>
              <tbody>
                ${rows.map(r=>`<tr><td>${r.id.slice(0,8)}</td><td>${r.panel}</td><td>${r.project}</td><td>${r.evaluator}</td><td><b>${r.total}</b></td><td>${r.finalized}</td><td class="small">${r.time}</td></tr>`).join('')||'<tr><td colspan="7" class="muted" style="text-align:center;padding:20px">No submissions yet.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    },
    
    migrateIDs(){
      if(!confirm('This will convert all IDs to simple format (PRJ-0001, EVAL-0001, etc.)\n\nContinue?')) return;
      IDMigration.migrate();
    }
  };

  /********************
   * Evaluator Module
   ********************/
  const Eval = {
    currentProject:null,
    draft:null,

    showProfileForm(){ 
      UI.show('evalProfile'); 
      const ev=Auth.currentEval; 
      if(ev){ 
        document.getElementById('profName').value=ev.name||''; 
        document.getElementById('profExpertise').value=ev.expertise||''; 
        document.getElementById('profNotes').value=ev.notes||''; 
      } 
    },

    saveProfile(){
      const name = document.getElementById('profName').value.trim();
      const expertise = document.getElementById('profExpertise').value.trim();
      const notes = document.getElementById('profNotes').value.trim();
      if(!name){ 
        document.getElementById('profMsg').textContent='Name is required.'; 
        document.getElementById('profMsg').style.color='var(--bad)';
        return; 
      }
      Auth.currentEval.name = name; 
      Auth.currentEval.expertise = expertise; 
      Auth.currentEval.notes = notes;
      const idx = DB.evaluators.findIndex(e=>e.id===Auth.currentEval.id);
      if(idx>=0) DB.evaluators[idx] = Auth.currentEval;
      Store.save();
      this.goToAssigned(); 
      UI.syncBranding();
    },

    _evaluatorFinalized(){
      return (DB.evaluatorState && DB.evaluatorState[Auth.currentEval.id] && DB.evaluatorState[Auth.currentEval.id].finalizedAll) === true;
    },

    goToAssigned(){
      UI.show('evalProjects');

      const myPanels = DB.panels.filter(p=>p.evaluatorIds.includes(Auth.currentEval.id));
      const myProjectIds = [...new Set(myPanels.flatMap(p=>p.projectIds))];

      const total = myProjectIds.length;
      const completed = DB.results.filter(r=>r.evaluatorId===Auth.currentEval.id && myProjectIds.includes(r.projectId)).length;
      const left = Math.max(0, total - completed);
      const pct = total === 0 ? 0 : Math.round((completed/total)*100);
      
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressCount').textContent = `${completed} / ${total} completed (${pct}%)`;
      document.getElementById('leftCount').textContent = `${left} left to evaluate`;

      const rows = myProjectIds.map(pid=>{
        const p = DB.projects.find(x=>x.id===pid) || {title:'(missing)'};
        const submitted = DB.results.find(r=>r.projectId===pid && r.evaluatorId===Auth.currentEval.id);
        if(submitted){
          return `<tr>
            <td><b>${p.title}</b><div class="hint">${p.category||''}</div></td>
            <td>${p.team||'—'}</td>
            <td>${p.school||'—'}</td>
            <td><span class="pill success">Submitted</span></td>
            <td>
              <div class="toolbar">
                <button class="btn" onclick="Eval.openViewOnlyModalByProject('${pid}')">View</button>
              </div>
            </td>
          </tr>`;
        } else {
          return `<tr>
            <td><b>${p.title}</b><div class="hint">${p.category||''}</div></td>
            <td>${p.team||'—'}</td>
            <td>${p.school||'—'}</td>
            <td><span class="pill">Pending</span></td>
            <td>
              <div class="toolbar">
                <button class="btn" onclick="Eval.openRubricModal('${pid}')">Evaluate</button>
              </div>
            </td>
          </tr>`;
        }
      }).join('');

      document.getElementById('evalProjectTable').innerHTML = `
        <table>
          <thead><tr><th>Project</th><th>Team</th><th>School</th><th>Status</th><th>Action</th></tr></thead>
          <tbody>${rows||'<tr><td colspan="5" class="muted" style="text-align:center;padding:20px">No projects assigned yet.</td></tr>'}</tbody>
        </table>`;

      const toolbar = document.getElementById('evalToolbar'); 
      toolbar.innerHTML = '';
      
      if(this._evaluatorFinalized()){
        toolbar.appendChild(U.el(`<div style="flex:1"></div>`));
        const logoutBtn = U.el(`<button class="btn secondary">Logout</button>`); 
        logoutBtn.onclick = ()=>Auth.logoutEvaluator();
        toolbar.appendChild(logoutBtn);
        return;
      }

      const proceedBtn = U.el(`<button class="btn" id="proceedFinalizeBtn">Proceed to Finalize</button>`);
      proceedBtn.onclick = ()=>this.openFinalizeModal();
      const spacer = U.el(`<div style="flex:1"></div>`);
      const logoutBtn = U.el(`<button class="btn secondary">Logout</button>`); 
      logoutBtn.onclick = ()=>Auth.logoutEvaluator();
      toolbar.appendChild(proceedBtn); 
      toolbar.appendChild(spacer); 
      toolbar.appendChild(logoutBtn);
    },

    openRubricModal(projectId){
      const project = DB.projects.find(p=>p.id===projectId) || {title:'(missing)'};
      const panel = DB.panels.find(p=>p.projectIds.includes(projectId) && p.evaluatorIds.includes(Auth.currentEval.id));
      const prior = DB.results.find(r=>r.projectId===projectId && r.evaluatorId===Auth.currentEval.id);
      const defs = DB.rubricDefs;
      const container = document.getElementById('modalContainer'); 
      container.innerHTML = '';
      
      const modal = U.el(`<div class="modal-wrap"><div class="modal" role="dialog" aria-modal="true" aria-label="Rubric: ${project.title}"></div></div>`);
      const modalInner = modal.querySelector('.modal');

      const fieldsHtml = defs.map(d=>{
        const val = prior ? (prior.scores?.[d.key] ?? '') : '';
        return `<div style="margin-bottom:10px">
          <label>${d.label} <span class="muted">(0–10)</span></label>
          <input type="number" min="0" max="10" step="1" data-score="${d.key}" value="${val}">
          <div class="error hidden">Enter a value between 0 and 10.</div>
        </div>`;
      }).join('');

      modalInner.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
          <h2 style="margin:0;font-size:18px">${project.title}</h2>
          <div style="font-size:12px;color:var(--muted)">${project.school || ''}</div>
        </div>
        <div class="hint" style="margin-bottom:12px">Team: ${project.team||'—'} | Category: ${project.category||'—'}</div>
        <div id="rubricFields">${fieldsHtml}</div>
        <label style="margin-top:8px">Overall Remark (optional)</label>
        <textarea id="rubricRemark" placeholder="Your comments about this project">${prior?prior.remark||'':''}</textarea>
        <div style="margin-top:12px" class="toolbar">
          <button class="btn" id="saveAndClose">Save & Close</button>
          <button class="btn" id="reviewBtn">Review</button>
          <button class="btn secondary" id="cancelRubric">Cancel</button>
        </div>
      `;
      container.appendChild(modal);

      this.draft = { 
        id: prior?.id || U.uid('result'), 
        panelId: panel?.id, 
        projectId: projectId, 
        evaluatorId: Auth.currentEval.id, 
        scores: prior?.scores ? {...prior.scores} : {}, 
        remark: prior?.remark || '', 
        total: prior?.total || 0, 
        ts: prior?.ts || Date.now(), 
        finalizedByEvaluator: prior?.finalizedByEvaluator || false 
      };

      modal.querySelector('#cancelRubric').onclick = ()=>{ modal.remove(); container.innerHTML=''; };
      modal.querySelector('#reviewBtn').onclick = ()=>{ this.prepareReviewFromModal(modal); };
      modal.querySelector('#saveAndClose').onclick = ()=>{ this.saveFromModal(modal, true); };
      modal.querySelector('[data-score]')?.focus();
    },

    prepareReviewFromModal(modal){
      const inputs = [...modal.querySelectorAll('[data-score]')];
      for(const inp of inputs){
        const v = Number(inp.value);
        const err = inp.nextElementSibling;
        if(isNaN(v) || v<0 || v>10){ 
          err.classList.remove('hidden'); 
          alert('Please fix invalid scores (0–10 only).'); 
          inp.focus();
          return; 
        }
        err.classList.add('hidden');
        this.draft.scores[inp.dataset.score] = v;
      }
      this.draft.total = Object.values(this.draft.scores).reduce((a,b)=>a+Number(b),0);
      this.draft.remark = modal.querySelector('#rubricRemark').value.trim();
      
      modal.querySelector('.modal').innerHTML = `
        <h3>Review Your Scores</h3>
        <div class="card">
          <table>
            <thead><tr><th>Criterion</th><th>Score</th></tr></thead>
            <tbody>${Object.entries(this.draft.scores).map(([k,v])=>`<tr><td>${DB.rubricDefs.find(d=>d.key===k)?.label||k}</td><td><b>${v}</b></td></tr>`).join('')}</tbody>
          </table>
          <p style="margin-top:12px;font-size:16px"><b>Total:</b> ${this.draft.total} / ${DB.rubricDefs.length*10}</p>
          <p style="margin-top:8px"><b>Remark:</b> ${this.draft.remark||'<span class="muted">none</span>'}</p>
        </div>
        <div style="margin-top:12px" class="toolbar">
          <button class="btn" id="confirmSubmit">Submit</button>
          <button class="btn secondary" id="editScores">Edit Scores</button>
          <button class="btn" id="saveDraft">Save Draft & Close</button>
        </div>
      `;
      modal.querySelector('#editScores').onclick = ()=>{ modal.remove(); document.getElementById('modalContainer').innerHTML=''; this.openRubricModal(this.draft.projectId); };
      modal.querySelector('#confirmSubmit').onclick = async ()=>{
        await this.submitDraft();
        modal.remove(); document.getElementById('modalContainer').innerHTML='';
        this.goToAssigned();
      };
      modal.querySelector('#saveDraft').onclick = ()=>{ this.saveDraftOnly(); modal.remove(); document.getElementById('modalContainer').innerHTML=''; this.goToAssigned(); };
    },

    saveFromModal(modal, closeAfterSave){
      const inputs = [...modal.querySelectorAll('[data-score]')];
      for(const inp of inputs){
        const v = Number(inp.value);
        const err = inp.nextElementSibling;
        if(isNaN(v) || v<0 || v>10){ 
          err.classList.remove('hidden'); 
          alert('Please fix invalid scores (0–10 only).'); 
          inp.focus();
          return; 
        }
        err.classList.add('hidden');
        this.draft.scores[inp.dataset.score] = v;
      }
      this.draft.total = Object.values(this.draft.scores).reduce((a,b)=>a+Number(b),0);
      this.draft.remark = modal.querySelector('#rubricRemark').value.trim();
      const existingIdx = DB.results.findIndex(r=>r.id===this.draft.id);
      if(existingIdx>=0) DB.results[existingIdx] = this.draft; else DB.results.push(this.draft);
      Store.save();
      if(closeAfterSave){
        modal.remove(); document.getElementById('modalContainer').innerHTML='';
        this.goToAssigned();
      }
    },

    saveDraftOnly(){
      const existingIdx = DB.results.findIndex(r=>r.id===this.draft.id);
      if(existingIdx>=0) DB.results[existingIdx] = this.draft; else DB.results.push(this.draft);
      Store.save();
    },

    async submitDraft(){
      this.draft.ts = Date.now();
      const existingIdx = DB.results.findIndex(r=>r.id===this.draft.id);
      if(existingIdx>=0) DB.results[existingIdx] = this.draft; else DB.results.push(this.draft);
      Store.save();
      if(DB.settings.gasUrl){
        try{ 
          await GASSync.syncResult(this.draft);
        }catch(e){
          console.warn('GAS sync failed',e)
        }
      }
    },

    openViewOnlyModalByProject(projectId){
      const res = DB.results.find(r=>r.projectId===projectId && r.evaluatorId===Auth.currentEval.id);
      if(!res){ alert('Submission not found'); return; }
      this.openViewOnlyModal(res);
    },

    openViewOnlyModal(res){
      const project = DB.projects.find(p=>p.id===res.projectId) || {title:'—'};
      const container = document.getElementById('modalContainer');
      const vmodal = U.el(`<div class="modal-wrap"><div class="modal" role="dialog" aria-modal="true" aria-label="View submission"></div></div>`);
      const defs = DB.rubricDefs;
      const rows = defs.map(d=>`<tr><td>${d.label}</td><td><b>${res.scores?.[d.key] ?? '—'}</b></td></tr>`).join('');
      vmodal.querySelector('.modal').innerHTML = `
        <h3>Submission: ${project.title}</h3>
        <div class="hint" style="margin-bottom:12px">Team: ${project.team||'—'} | School: ${project.school||'—'}</div>
        <div class="card">
          <table>
            <thead><tr><th>Criterion</th><th>Score</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <p style="margin-top:12px;font-size:16px"><b>Total:</b> ${res.total||0} / ${defs.length*10}</p>
          <p style="margin-top:8px"><b>Remark:</b> ${res.remark||'<span class="muted">none</span>'}</p>
          <p style="margin-top:8px;color:var(--muted);font-size:13px">${res.finalizedByEvaluator? '✓ Finalized' : 'Not Finalized'}</p>
        </div>
        <div style="margin-top:12px" class="toolbar">
          <button class="btn" id="closeView">Close</button>
        </div>
      `;
      container.appendChild(vmodal);
      vmodal.querySelector('#closeView').onclick = ()=>{ vmodal.remove(); };
    },

    openFinalizeModal(){
      const subs = DB.results.filter(r=>r.evaluatorId===Auth.currentEval.id);
      if(subs.length===0){
        alert('No submissions yet. Submit at least one rubric before proceeding.');
        return;
      }
      const container = document.getElementById('modalContainer'); 
      container.innerHTML='';
      const modalWrap = U.el(`<div class="modal-wrap"></div>`);
      const modal = U.el(`<div class="modal" role="dialog" aria-modal="true" aria-label="Review submissions"></div>`);
      modalWrap.appendChild(modal);

      modal.innerHTML = `
        <h2>Review Your Submissions</h2>
        <div class="hint" style="margin-bottom:12px">Review all your evaluations before finalizing. Once finalized, you can only logout.</div>
        <div class="card" style="margin-bottom:12px">
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Project</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody>
                ${subs.map(s=>`<tr data-resid="${s.id}">
                  <td><b>${(DB.projects.find(p=>p.id===s.projectId)?.title)||'—'}</b></td>
                  <td><b>${s.total||0}</b></td>
                  <td>${s.finalizedByEvaluator?'<span class="pill success">Finalized</span>':'<span class="pill">Not Finalized</span>'}</td>
                  <td>
                    <div class="toolbar">
                      <button class="btn" data-view="${s.id}">View</button>
                      <button class="btn secondary" data-edit="${s.id}">Edit</button>
                    </div>
                  </td>
                </tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <div class="toolbar">
          <button class="btn" id="finalizeAllBtn">Finalize All Submissions</button>
          <button class="btn secondary" id="cancelFinalizeBtn">Cancel</button>
        </div>
      `;

      container.appendChild(modalWrap);

      modal.querySelectorAll('[data-view]').forEach(b=>{
        b.onclick = (e)=>{
          const rid = e.target.getAttribute('data-view');
          const res = DB.results.find(r=>r.id===rid);
          this.openViewOnlyModal(res);
        };
      });
      
      modal.querySelectorAll('[data-edit]').forEach(b=>{
        b.onclick = (e)=>{
          const rid = e.target.getAttribute('data-edit');
          const res = DB.results.find(r=>r.id===rid);
          modalWrap.remove();
          container.innerHTML='';
          this.openRubricModal(res.projectId);
        };
      });

      modal.querySelector('#cancelFinalizeBtn').onclick = ()=>{ modalWrap.remove(); container.innerHTML=''; };

      modal.querySelector('#finalizeAllBtn').onclick = async ()=>{
        if(!confirm('Click OK to finalize ALL your submissions. After finalizing, the screen will show only the Logout button.')) return;
        
        subs.forEach(s=>{
          s.finalizedByEvaluator = true;
        });
        
        DB.evaluatorState = DB.evaluatorState || {};
        DB.evaluatorState[Auth.currentEval.id] = DB.evaluatorState[Auth.currentEval.id] || {};
        DB.evaluatorState[Auth.currentEval.id].finalizedAll = true;
        Store.save();
        
        if(DB.settings.gasUrl){
          await GASSync.syncAll();
        }
        
        modalWrap.remove();
        container.innerHTML='';
        this.goToAssigned();
        alert('✓ All submissions finalized successfully!');
      };
    }
  };

  // Initialize
  UI.syncBranding();

  // Sample Data (only if empty)
  if(DB.projects.length===0 && DB.evaluators.length===0 && DB.panels.length===0){
    const p1={id:U.uid('project'),title:'Smart Irrigation System',category:'IoT',team:'GreenTech',school:'City High',contact:'mentor@city.edu'};
    const p2={id:U.uid('project'),title:'Air Quality Mapper',category:'Environmental',team:'ClearSkies',school:'Sunrise School',contact:'lead@sunrise.edu'};
    const p3={id:U.uid('project'),title:'AI Waste Sorter',category:'AI/ML',team:'EcoBots',school:'Riverdale',contact:'lab@riverdale.edu'};
    DB.projects.push(p1,p2,p3);
    
    const e1={id:U.uid('evaluator'),name:'Dr. A. Rao',email:'rao@example.com',expertise:'IoT',code:123456};
    const e2={id:U.uid('evaluator'),name:'Ms. B. Shah',email:'shah@example.com',expertise:'AI/ML',code:234567};
    const e3={id:U.uid('evaluator'),name:'Mr. C. Patel',email:'patel@example.com',expertise:'Enviro',code:345678};
    const e4={id:U.uid('evaluator'),name:'Dr. D. Iyer',email:'iyer@example.com',expertise:'Robotics',code:456789};
    DB.evaluators.push(e1,e2,e3,e4);
    
    DB.panels.push({id:U.uid('panel'),name:'Panel 1',evaluatorIds:[e1.id,e2.id,e3.id],projectIds:[p1.id,p2.id,p3.id]});
    Store.save();
  }

  window.addEventListener('load', ()=>{ 
    if(Auth.currentEval) Eval.goToAssigned(); 
  });
  </script>

  <!-- 
  =====================================================
  GOOGLE APPS SCRIPT (GAS) BACKEND CODE
  =====================================================
  
  SETUP INSTRUCTIONS:
  1. Create a new Google Sheet
  2. Go to Extensions → Apps Script
  3. Delete any default code
  4. Copy and paste ALL the code below
  5. Click "Deploy" → "New deployment"
  6. Choose type: "Web app"
  7. Settings:
     - Execute as: Me
     - Who has access: Anyone
  8. Click "Deploy"
  9. Copy the Web App URL (ends with /exec)
  10. Paste in Admin Settings → GAS URL
  
  =====================================================
  -->
  
  <!--
  
  function doPost(e) {
    try {
      // Handle CORS
      const output = ContentService.createTextOutput();
      output.setMimeType(ContentService.MimeType.JSON);
      
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const body = JSON.parse(e.postData.contents || '{}');
      const type = body.type || 'unknown';
      const timestamp = body.timestamp || Date.now();
      
      // Log all requests
      logRequest(ss, type, timestamp);
      
      if (type === 'bulk') {
        const result = handleBulkSync(ss, body.data);
        output.setContent(JSON.stringify(result));
        return output;
      }
      
      if (type === 'result') {
        const result = handleResultSync(ss, body.data);
        output.setContent(JSON.stringify(result));
        return output;
      }
      
      output.setContent(JSON.stringify({ok: false, error: 'Unknown type: ' + type}));
      return output;
      
    } catch (err) {
      const output = ContentService.createTextOutput();
      output.setMimeType(ContentService.MimeType.JSON);
      output.setContent(JSON.stringify({ok: false, error: err.toString()}));
      return output;
    }
  }

  function handleBulkSync(ss, data) {
    const {settings, evaluators, projects, panels, results, evaluatorState} = data;
    
    // Settings Sheet
    let settingsSheet = ss.getSheetByName('Settings');
    if (!settingsSheet) settingsSheet = ss.insertSheet('Settings');
    settingsSheet.clear();
    const settingsData = [['Key', 'Value']];
    for (let key in settings) {
      settingsData.push([key, String(settings[key] || '')]);
    }
    if (settingsData.length > 1) {
      settingsSheet.getRange(1, 1, settingsData.length, 2).setValues(settingsData);
      settingsSheet.getRange(1, 1, 1, 2).setFontWeight('bold').setBackground('#4a5568');
      settingsSheet.autoResizeColumn(1);
      settingsSheet.autoResizeColumn(2);
    }
    
    // Evaluators Sheet
    let evalSheet = ss.getSheetByName('Evaluators');
    if (!evalSheet) evalSheet = ss.insertSheet('Evaluators');
    evalSheet.clear();
    const evalData = [['Evaluator ID', 'Name', 'Email', 'Expertise', 'Access Code', 'Notes']];
    evaluators.forEach(e => {
      evalData.push([e.id || '', e.name || '', e.email || '', e.expertise || '', e.code || '', e.notes || '']);
    });
    if (evalData.length > 1) {
      evalSheet.getRange(1, 1, evalData.length, 6).setValues(evalData);
      evalSheet.getRange(1, 1, 1, 6).setFontWeight('bold').setBackground('#4a5568');
      for (let i = 1; i <= 6; i++) evalSheet.autoResizeColumn(i);
    }
    
    // Projects Sheet
    let projSheet = ss.getSheetByName('Projects');
    if (!projSheet) projSheet = ss.insertSheet('Projects');
    projSheet.clear();
    const projData = [['Project ID', 'Title', 'Category', 'Team', 'School', 'Contact']];
    projects.forEach(p => {
      projData.push([p.id || '', p.title || '', p.category || '', p.team || '', p.school || '', p.contact || '']);
    });
    if (projData.length > 1) {
      projSheet.getRange(1, 1, projData.length, 6).setValues(projData);
      projSheet.getRange(1, 1, 1, 6).setFontWeight('bold').setBackground('#4a5568');
      for (let i = 1; i <= 6; i++) projSheet.autoResizeColumn(i);
    }
    
    // Panels Sheet
    let panelSheet = ss.getSheetByName('Panels');
    if (!panelSheet) panelSheet = ss.insertSheet('Panels');
    panelSheet.clear();
    const panelData = [['Panel ID', 'Panel Name', 'No. of Members', 'Member Names', 'No. of Projects', 'Project Names']];
    panels.forEach(p => {
      const memberCount = (p.evaluatorIds || []).length;
      const projectCount = (p.projectIds || []).length;
      
      // Get member names
      const memberNames = (p.evaluatorIds || []).map(eid => {
        const evaluator = evaluators.find(e => e.id === eid);
        return evaluator ? evaluator.name : eid;
      }).join(', ');
      
      // Get project names
      const projectNames = (p.projectIds || []).map(pid => {
        const project = projects.find(pr => pr.id === pid);
        return project ? project.title : pid;
      }).join(', ');
      
      panelData.push([
        p.id || '', 
        p.name || '', 
        memberCount,
        memberNames,
        projectCount,
        projectNames
      ]);
    });
    if (panelData.length > 1) {
      panelSheet.getRange(1, 1, panelData.length, 6).setValues(panelData);
      
      // Format header row
      panelSheet.getRange(1, 1, 1, 6).setFontWeight('bold').setBackground('#4a5568');
      
      // Auto-resize columns
      for (let i = 1; i <= 6; i++) {
        panelSheet.autoResizeColumn(i);
      }
    }
    
    // Results Sheet
    let resSheet = ss.getSheetByName('Results');
    if (!resSheet) resSheet = ss.insertSheet('Results');
    resSheet.clear();
    const resData = [['Result ID', 'Panel ID', 'Project ID', 'Evaluator ID', 'Total Score', 'Remark', 'Finalized', 'Timestamp', 'Problem (10)', 'Originality (10)', 'Description (10)', 'Method (10)', 'Impact (10)', 'Presentation (10)']];
    results.forEach(r => {
      const scores = r.scores || {};
      resData.push([
        r.id || '',
        r.panelId || '',
        r.projectId || '',
        r.evaluatorId || '',
        r.total || 0,
        r.remark || '',
        r.finalizedByEvaluator ? 'Yes' : 'No',
        new Date(r.ts || Date.now()),
        scores.problem || '',
        scores.originality || '',
        scores.description || '',
        scores.method || '',
        scores.impact || '',
        scores.presentation || ''
      ]);
    });
    if (resData.length > 1) {
      resSheet.getRange(1, 1, resData.length, 14).setValues(resData);
      resSheet.getRange(1, 1, 1, 14).setFontWeight('bold').setBackground('#4a5568');
      for (let i = 1; i <= 14; i++) resSheet.autoResizeColumn(i);
    }
    
    // Evaluator State Sheet
    let stateSheet = ss.getSheetByName('EvaluatorState');
    if (!stateSheet) stateSheet = ss.insertSheet('EvaluatorState');
    stateSheet.clear();
    const stateData = [['Evaluator ID', 'Finalized All Submissions']];
    if (evaluatorState) {
      for (let evalId in evaluatorState) {
        const state = evaluatorState[evalId] || {};
        stateData.push([evalId, state.finalizedAll ? 'Yes' : 'No']);
      }
    }
    if (stateData.length > 1) {
      stateSheet.getRange(1, 1, stateData.length, 2).setValues(stateData);
      stateSheet.getRange(1, 1, 1, 2).setFontWeight('bold').setBackground('#4a5568');
      stateSheet.autoResizeColumn(1);
      stateSheet.autoResizeColumn(2);
    }
    
    return {
      ok: true, 
      mode: 'bulk', 
      timestamp: new Date().toISOString(),
      synced: {
        settings: Object.keys(settings || {}).length,
        evaluators: (evaluators || []).length,
        projects: (projects || []).length,
        panels: (panels || []).length,
        results: (results || []).length
      }
    };
  }

  function handleResultSync(ss, result) {
    let resSheet = ss.getSheetByName('Results');
    if (!resSheet) {
      resSheet = ss.insertSheet('Results');
      resSheet.appendRow(['ID', 'Panel ID', 'Project ID', 'Evaluator ID', 'Total', 'Remark', 'Finalized', 'Timestamp', 'Problem', 'Originality', 'Description', 'Method', 'Impact', 'Presentation']);
    }
    
    const scores = result.scores || {};
    resSheet.appendRow([
      result.id || '',
      result.panelId || '',
      result.projectId || '',
      result.evaluatorId || '',
      result.total || 0,
      result.remark || '',
      result.finalizedByEvaluator ? 'Yes' : 'No',
      new Date(result.ts || Date.now()),
      scores.problem || '',
      scores.originality || '',
      scores.description || '',
      scores.method || '',
      scores.impact || '',
      scores.presentation || ''
    ]);
    
    return {ok: true, saved: result.id, timestamp: new Date().toISOString()};
  }

  function logRequest(ss, type, timestamp) {
    try {
      let logSheet = ss.getSheetByName('_RequestLog');
      if (!logSheet) {
        logSheet = ss.insertSheet('_RequestLog');
        logSheet.appendRow(['Timestamp', 'Type']);
      }
      logSheet.appendRow([new Date(timestamp), type]);
    } catch (err) {
      // Fail silently - logging is not critical
      console.error('Log error:', err);
    }
  }

  function doGet(e) {
    const output = ContentService.createTextOutput();
    output.setMimeType(ContentService.MimeType.JSON);
    output.setContent(JSON.stringify({
      ok: true, 
      message: 'Science Exhibition Evaluation System - GAS Backend',
      version: '2.0',
      timestamp: new Date().toISOString(),
      status: 'Active'
    }));
    return output;
  }
  
  -->

</body>
</html>
